# Shelly Scripts

To install, copy the source code of the script, then add to Shelly device using one of Shelly provided options.

For your convenience, you can add following url to scripts source in your Shelly: 
```
https://raw.githubusercontent.com/michalk-k/shelly-scripts/main/manifest.json
```

Read documentation for further steps.

## MQTT DISCOVERY SELF

> It requires the MQTT to be enabled and configured in the Shelly device.

The script registers the Shelly device the script runs on and its entities, to Home Assistant, using MQTT discovery.\
It creates entities for all supported properties: switches, sensors etc.

Currently supports following SHelly components (they can be found in different SHelly devices):
* switch
* pm1
* wifi *)
* em
* emdata
* temperature **)

*) wifi component isn't originally repoted to MQTT. This script adds periodical reporting of Wifi component status to topic configured in MQTT configuration ![WIFI added to MQTT](images/mqtt_wifi.png)
**) Shelly devices report temperature only on temperature changes. Once temperature stabilizes, MQTT topic is not updated anymore. In conjunction with non-retained topic, it might lead to unknown value for long time, ie after HA restart or HA entity reinitialization.

SO far tested with following devices:
* Mini PM gen3
* Plus 2PM (gen2)
* Pro EM3 (gen2)

![Device Page](images/device_page_overview.png)

**Features**
* easy to use: just run it
* by default creates generic device and entity names (see Naming below)
* device and entity names might be overriden by shelly device configuration (device name and channel names)
* switch can be reported as a light entity to HA (set `consumption type` to `light`)
* some of sensors are disabled by default, for example power factor or voltage.
* The script follows recent Home Assistant conventions in how to setup entities.


### Naming

**Device**

The device name follows the pattern: : `macaddress-modelname`, for example `b8d6xxxxxxxx-Plus2PM`.\
It can be overriden by setting Device name (Settings / Device Name). To apply changes, the script must be restarted

> Note, the Home Assistant uses device name as a prefix for entity names. Changing device when entities are already registered, affect no entity names

**Entities**

By default **entity name** follows the tracked attribute function, for example: `Switch`, `Frequency`, `Power Factor`, `RSSI`. If the device contains more components of the same type (ie measurement channels), the names are suffixed by oridinal numbers, for example `Switch 1`, `Switch 2`, `Frequency 1`, `Frequency 2`, etc.

If device channel has a custom name configured (as for example, `Output -> Name` in Shelly2PM), all related entity names gets name as follows: `Custom Name Function`, For example `Dryer Socket Frequency`. in this case the oridinal number of Shelly component is not appended.

The **friendly_name** is created by Home Assistant from the device name and the entity name. It might look like `b8d6xxxxxxxx-Plus2PM Active Power 2` or `b8d6xxxxxxxx-Plus2PM Backlight`. Looks horrible, but once device name is changed to something meaningfull, ie AlcoveLight, the friendly name will turn into `AlcoveLight Active Power 2` or `AlcoveLight Backlight` respectively.

The **unique_id** allways follows the pattern: `macaddress-function` or `macaddress-function-number`, for example `macaddress-rssi` or `b8d6xxxxxxxx_power_factor_1`. Unique id never changes and is not influenced by configuration settings.

The **entity_id** is not set by this script. The entity name is generated by Home Assistant from `device_name_entity_name` pattern, for example `sensor.b8d61a89xxxx_plus2pm_active_energy_2`. The `entity_id` may be influenced by the Device name set in Shelly configuration or changed later on in Home Assistant.

### Alternative Device Class
It's often useful to have a switch interpreted by Home Assistant as a light.

It can be achieved in Home Assistant with use of "Change device type of a switch" helper. But it creates additional entity in the system.

Shelly devices allows to enter this information into `(Output Settings -> Consumption Type)`. Entering `light` makes the switch be reported as a light to Home Assistant.

> Currently only `light` as alternative device class is supported

Note, that the change neither influences `unique_id`, `entity_id` or mqtt topic names. But it will change the `entity name` and `friendly name` of the entity.